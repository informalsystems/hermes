#!/usr/bin/env sh
#set -x
set -eu

version() {
  echo "v0.0.1"
}

install() {
  mkdir -p "${HOME}/.gm/bin"
  cp "$0" "${HOME}/.gm/bin/gm"
  chmod 755 "${HOME}/.gm/bin/gm"
  cp "${0%%gm}lib-gm" "${HOME}/.gm/bin/lib-gm"
  chmod 644 "${HOME}/.gm/bin/lib-gm"
  cp "${0%%gm}shell-support" "${HOME}/.gm/bin/shell-support"
  chmod 644 "${HOME}/.gm/bin/shell-support"
  CONFIG_FILE="${HOME}/.gm/gm.toml"
  if [ ! -f "$CONFIG_FILE" ]; then
    write_default_config
  fi
  if [ -z "$(which stoml)" ]; then
    warn "missing mandatory stoml, install it from https://github.com/freshautomations/stoml/releases"
  fi
  if [ -z "$(which sconfig)" ]; then
    warn "missing mandatory sconfig, install it from https://github.com/freshautomations/sconfig/releases"
  fi
  if [ ! -d /usr/local/etc/bash_completion.d ]; then
    warn "run \"brew install bash-completion\" to install optional bash completion"
  fi
  echo "Please add \"source $HOME/.gm/bin/shell-support\" to your .profile, .bash_profile or other startup script and restart your shell."
}

enforce_requirements() {
  if [ -z "$(which stoml)" ]; then
    exit_with_error "missing stoml, install it from https://github.com/freshautomations/stoml/releases"
  fi
  if [ -z "$(which sconfig)" ]; then
    exit_with_error "missing sconfig, install it from https://github.com/freshautomations/sconfig/releases"
  fi
}

debug() {
  if [ -n "${DEBUG:-}" ]; then
    echo "DEBUG: $*"
  fi
}

warn() {
  echo "WARNING: $*"
}

warn_unknown_node() {
  if ! a_in_b "$1" "$ALL_NODES"; then
    warn "unknown node $1, skipping..."
    return 1
  fi
}

exit_with_error() {
  echo "ERROR: $*, exiting..."
  return 1
}

usage() {
  echo "Gaiad Manager $(version)"
  echo 
  echo "Usage:"
  echo "  gm <COMMAND> [[<PARAMS>]...]"
  echo
  echo "COMMANDS    DESCRIPTION"
  echo
  echo "help        print this help and exit"
  echo "install     install the script for the local user"
  echo "keys        print the keys of validator nodes"
  echo "log         print the log of a node"
  echo "ports       print the ports of a (running) node"
  echo "start       start one or more nodes (starts all nodes if no parameter is given)"
  echo "status      print the status of nodes"
  echo "stop        stop one or more nodes (stops all nodes if no parameter is given)"
  echo
}

# Is string A in space-separated list B?
a_in_b() {
  test -n "$(echo "$2" | grep '\(^\| \+\)'"${1}"'\( \+\|$\)')"
}

# Todo: fix "stoml" so it reads empty sections too - currently we work around this with the mandatory comment.
load_config() {
  FRESH_CONFIG=no
  if [ -f "${SCRIPT_DIR}gm.toml" ]; then
    export CONFIG_FILE="${SCRIPT_DIR}gm.toml"
  elif [ -f "${HOME}/.gm/gm.toml" ]; then
    export CONFIG_FILE="${HOME}/.gm/gm.toml"
  else
    FRESH_CONFIG=yes
    if [ -d "${HOME}/.gm" ]; then
      export CONFIG_FILE="${HOME}/.gm/gm.toml"
    else
      export CONFIG_FILE="${SCRIPT_DIR}gm.toml"
    fi
  fi
  GLOBAL_GAIAD_BINARY="$(eval echo "$(stoml -q "$CONFIG_FILE" global.gaiad_binary || which gaiad)")"
  GLOBAL_PORTS_START_AT="$(stoml -q "$CONFIG_FILE" global.ports_start_at || echo 27000)"
  GLOBAL_HOME_DIR="$(eval echo "$(stoml -q "$CONFIG_FILE" global.home_dir || echo "${HOME}/.gm")")"
  GLOBAL_AUTO_MAINTAIN_CONFIG="$(stoml -q "$CONFIG_FILE" global.auto_maintain_config || echo "true")"
  export GLOBAL_GAIAD_BINARY
  export GLOBAL_PORTS_START_AT
  export GLOBAL_HOME_DIR
  export GLOBAL_AUTO_MAINTAIN_CONFIG
  if [ "$FRESH_CONFIG" = "yes" ]; then
    write_default_config
    VALIDATORS=""
    FULL_NODES=""
  else
    stoml "$CONFIG_FILE" global 1> /dev/null || exit_with_error invalid config file. Make sure all strings are quoted
    test -x "$GLOBAL_GAIAD_BINARY" || exit_with_error "gaiad binary cannot be executed: $GLOBAL_GAIAD_BINARY"
    RAW_SECTIONS="$(stoml -q "$CONFIG_FILE" . || echo "")"
    VALIDATORS=""
    RAW_NODES=""
    for i in $RAW_SECTIONS
    do
      if [ "$i" = "global" ]; then
        continue
      fi
      if [ -z "$(stoml "$CONFIG_FILE" "${i}.network")" ]; then
        VALIDATORS="$VALIDATORS $i"
      else
        RAW_NODES="$RAW_NODES $i"
      fi
    done
    FULL_NODES=""
    for i in $RAW_NODES
    do
      NODE_NETWORK="$(stoml "$CONFIG_FILE" "${i}.network")"
      if ! a_in_b "${NODE_NETWORK}" "$VALIDATORS"; then
        warn "invalid full node: $i, invalid network entry: ${NODE_NETWORK}, skipping..."
        continue
      fi
      FULL_NODES="${FULL_NODES} $i"
    done
  fi
  export VALIDATORS
  export FULL_NODES
  export ALL_NODES="$VALIDATORS $FULL_NODES"
}

write_default_config() {
  set +e
  cat <<EOF > "$CONFIG_FILE"
[global]
gaiad_binary="$GLOBAL_GAIAD_BINARY"
ports_start_at=$GLOBAL_PORTS_START_AT
home_dir="$GLOBAL_HOME_DIR"
auto_maintain_config=$GLOBAL_AUTO_MAINTAIN_CONFIG
comment="Please add comments to all node definitions. (Mandatory.)"
EOF
  set -e
}

get_gaiad_binary() {
  RESULT="$(stoml -q "$CONFIG_FILE" "${1}.gaiad_binary")"
  if [ -z "$RESULT" ]; then
    echo "$GLOBAL_GAIAD_BINARY"
  else
    eval echo "$RESULT"
  fi
}

get_ports_start_at() {
  RESULT="$(stoml -q "$CONFIG_FILE" "${1}.ports_start_at")"
  if [ -z "$RESULT" ]; then
    i=0
    for j in $ALL_NODES
    do
      if [ "$j" = "$1" ]; then
        break
      fi
      i=$((i+1))
    done
    echo "$((GLOBAL_PORTS_START_AT+10*i))"
  else
    echo "$RESULT"
  fi
}

get_rpc_port() {
  get_ports_start_at "$1"
}

get_app_port() {
  echo "$(($(get_ports_start_at "$1")+1))"
}

get_grpc_port() {
  echo "$(($(get_ports_start_at "$1")+2))"
}

get_p2p_port() {
  echo "$(($(get_ports_start_at "$1")+3))"
}

get_pprof_port() {
  echo "$(($(get_ports_start_at "$1")+4))"
}

get_home_dir() {
  RESULT="$(stoml -q "$CONFIG_FILE" "${1}.home_dir")"
  if [ -z "$RESULT" ]; then
    echo "$GLOBAL_HOME_DIR/$1"
  else
    eval echo "$RESULT"
  fi
}

get_auto_maintain_config() {
  RESULT="$(stoml -q "$CONFIG_FILE" "${1}.auto_maintain_config")"
  if [ -z "$RESULT" ]; then
    test "$GLOBAL_AUTO_MAINTAIN_CONFIG" = "true"
  else
    test "$RESULT" = "true"
  fi
}

get_network() {
  RESULT="$(stoml -q "$CONFIG_FILE" "${1}.network")"
  if [ -z "$RESULT" ]; then
    exit_on_error "Network not found for node ${1}"
  else
    if ! a_in_b "$RESULT" "$VALIDATORS"; then
      return 1
    fi
  fi
  echo "$RESULT"
}

get_node_id() {
  GAIAD="$(get_gaiad_binary "$1")"
  HOME_DIR="$(get_home_dir "$1")"
  $GAIAD tendermint show-node-id --home "$HOME_DIR"
}

create() {
  i="$1"
  echo "Creating $i config..."
  GAIAD="$(get_gaiad_binary "$i")"
  HOME_DIR="$(get_home_dir "$i")"
  HOME_ROOT="${HOME_DIR%%${i}}"
  if a_in_b "$i" "$VALIDATORS"; then
    EXEC_RESULT="$("$GAIAD" testnet --chain-id "$i" --keyring-backend test --node-dir-prefix "${i}v" -o "$HOME_ROOT" --node-daemon-home . --v 1 2>&1)"
    if [ "$EXEC_RESULT" != "Successfully initialized 1 node directories" ]; then
      warn "could not create config for ${i}: \"$EXEC_RESULT\", skipping..."
      return 1
    else
      mv "${HOME_ROOT}/${i}v0" "${HOME_DIR}"
      mv "${HOME_ROOT}/gentxs" "${HOME_DIR}"
      $GAIAD keys add "wallet" --keyring-backend test --keyring-dir "${HOME_DIR}" --output json > "${HOME_DIR}/wallet_seed.json"
      $GAIAD add-genesis-account "wallet" "10000000stake,10000${i}coin" --keyring-backend test --home "${HOME_DIR}"
    fi
  else
    NETWORK="$(get_network "$i")"
    EXEC_RESULT="$("$GAIAD" testnet --chain-id "$NETWORK" --keyring-backend test --node-dir-prefix "${i}n" -o "$HOME_ROOT" --node-daemon-home . --v 1 2>&1)"
    if [ "$EXEC_RESULT" != "Successfully initialized 1 node directories" ]; then
      warn "could not create config for ${i}: \"$EXEC_RESULT\", skipping..."
      return 1
    fi
    mv "${HOME_ROOT}/${i}n0" "${HOME_DIR}"
    rm -rf "${HOME_ROOT}/gentxs"
    # Todo: Maybe replace the below with calling the configure function.
    NETWORK_HOME_DIR="$(get_home_dir "$NETWORK")"
    cp "$NETWORK_HOME_DIR/config/genesis.json" "$HOME_DIR/config/genesis.json"
    NETWORK_NODE="$(get_node_id "$NETWORK")@localhost:$(get_p2p_port "$NETWORK")"
    sconfig "$HOME_DIR/config/config.toml" "p2p.persistent_peers=$NETWORK_NODE" 1> /dev/null
    if get_auto_maintain_config "$NETWORK"; then
      NODE_ID="$(get_node_id "$i")"
      sconfig "$NETWORK_HOME_DIR/config/config.toml" "p2p.unconditional_peer_ids=$NODE_ID" 1> /dev/null
      # Todo: Make this more robust: if two full nodes connect to the same validator, this override each other
    fi
  fi
  sconfig "$HOME_DIR/config/config.toml" p2p.addr_book_strict=false 1> /dev/null
  sconfig "$HOME_DIR/config/config.toml" p2p.allow_duplicate_ip=true 1> /dev/null
}

configure() {
  HOME_DIR="$(get_home_dir "$1")"
  # Todo: rpc.pprof_laddr=6060, maybe needs moving?
  # Todo: rpc.grpc also?
  P2P="$(get_p2p_port "$1")"
  RPC="$(get_rpc_port "$1")"
  #APP="$(get_app_port "$1")"
  #GRPC="$(get_grpc_port "$1")"
  PPROF="$(get_pprof_port "$1")"
  sconfig "$HOME_DIR/config/config.toml" "p2p.laddr=tcp://0.0.0.0:${P2P}" 1> /dev/null
  sconfig "$HOME_DIR/config/config.toml" "rpc.laddr=tcp://0.0.0.0:${RPC}" 1> /dev/null
  sconfig "$HOME_DIR/config/config.toml" "rpc.pprof_laddr=localhost:${PPROF}" 1> /dev/null
  # Todo: sconfig doesn't support it yet
  #sconfig "$HOME_DIR/config/app.toml" "api.address=tcp://0.0.0.0:${APP}" 1> /dev/null
  #sconfig "$HOME_DIR/config/app.toml" "grpc.address=0.0.0.0:${GRPC}" 1> /dev/null
  if ! a_in_b "$i" "$VALIDATORS"; then
    NETWORK="$(get_network "$1")"
    NETWORK_HOME_DIR="$(get_home_dir "$NETWORK")"
    cp "$NETWORK_HOME_DIR/config/genesis.json" "$HOME_DIR/config/genesis.json"
    NETWORK_NODE="$(get_node_id "$NETWORK")@localhost:$(get_p2p_port "$NETWORK")"
    sconfig "$HOME_DIR/config/config.toml" "p2p.persistent_peers=$NETWORK_NODE" 1> /dev/null
    if get_auto_maintain_config "$NETWORK"; then
      NODE_ID="$(get_node_id "$1")"
      sconfig "$NETWORK_HOME_DIR/config/config.toml" "p2p.unconditional_peer_ids=$NODE_ID" 1> /dev/null
      # Todo: Make this more robust: if two full nodes connect to the same validator, don't override each other
    fi
  fi
}

# Todo: (high-priority) fix sconfig to be able to map in app.toml
start() {
  GAIAD="$(get_gaiad_binary "$1")"
  HOME_DIR="$(get_home_dir "$1")"
  GAIAD_LOG="${HOME_DIR}/log"
  nohup "$GAIAD" start --x-crisis-skip-assert-invariants --home "$HOME_DIR" > "$GAIAD_LOG" 2>&1 &
  GAIAD_PID=$!
  echo "$GAIAD_PID" > "$HOME_DIR/pid"
  echo "$i started, PID: $GAIAD_PID, LOG: $GAIAD_LOG"
}

stop() {
  HOME_DIR="$(get_home_dir "$1")"
  #GAIAD_BINARY="$(get_gaiad_binary "$1")"
  test -f "${HOME_DIR}/pid"
  GAIAD_PID="$(cat "${HOME_DIR}/pid")"
  #COMM="$(ps -p "$GAIAD_PID" -o comm | tail -1)"
  echo "Stopping $1 with PID $GAIAD_PID..."
  kill -TERM "$GAIAD_PID" 2> /dev/null || echo "  No process with PID $GAIAD_PID. Cleaning up run config."
  sleep 2
  # Todo: make this more robust by checking if the process was killed properly
  rm -f "$HOME_DIR/pid"
}

print_header_line() {
  echo "NODE               PID    RPC   APP  GRPC HOME_DIR"
}

print_status_line() {
    NAME="${2:-}$1"
    NAME_LENGTH="${#NAME}"
    NAME_PAD=""
    if [ "$NAME_LENGTH" -lt 15 ]; then
      for p in $(seq "$NAME_LENGTH" 15);
      do
        NAME_PAD="$NAME_PAD "
      done
    fi
    HOME_DIR="$(get_home_dir "$1")"
    GAIAD_PID_FILE="${HOME_DIR}/pid"
    if [ -f "$GAIAD_PID_FILE" ]; then
      GAIAD_PID="$(cat "$GAIAD_PID_FILE")"
      if [ "$(ps -p "$GAIAD_PID" -o pid | wc -l)" -eq 2 ]; then
        echo "${NAME}${NAME_PAD} $GAIAD_PID  $(get_rpc_port "$1") $(get_app_port "$1") $(get_grpc_port "$1") $HOME_DIR"
      else
        echo "${NAME}${NAME_PAD}($GAIAD_PID)     -     -     - $HOME_DIR"
      fi
    else
       echo "${NAME}${NAME_PAD}     -      -     -     - $HOME_DIR"
    fi
}

status() {
  print_header_line
  for i in $VALIDATORS
  do
    print_status_line "$i"
    for j in $FULL_NODES
    do
      NETWORK="$(get_network "$j")"
      if [ "$i" = "$NETWORK" ]; then
        print_status_line "$j" "-"
      else
        continue
      fi
    done
  done
}

ports() {
  P2P="$(get_p2p_port "$1")"
  RPC="$(get_rpc_port "$1")"
  APP="$(get_app_port "$1")"
  GRPC="$(get_grpc_port "$1")"
  PPROF="$(get_pprof_port "$1")"
  echo "${1} RPC  : http://localhost:${RPC}"
  echo "${1} APP  : http://localhost:${APP}"
  echo "${1} GRPC : http://localhost:${GRPC}"
  echo "${1} P2P  : http://localhost:${P2P}"
  echo "${1} PPROF: http://localhost:${PPROF}"
}

list_keys() {
  HOME_DIR="$(get_home_dir "$1")"
  GAIAD_BINARY="$(get_gaiad_binary "$1")"
  echo "\"$GAIAD_BINARY\" keys list --keyring-backend test --keyring-dir \"$HOME_DIR\""
  KEY_NAME=""
  "$GAIAD_BINARY" keys list --keyring-backend test --keyring-dir "$HOME_DIR" | while read -r line
  do
    NAME="${line##'- name: '}"
    TYPE="${line##'type: '}"
    MNEMONIC="${line##'mnemonic:'}"
    THRESHOLD="${line##'threshold: '}"
    PUBKEYS="${line##'pubkeys: '}"
    if [ "$NAME" != "$line" ]; then
      KEY_NAME="$NAME"
      echo
      echo "$line"
    elif [ "$TYPE" != "$line" ]; then
      if [ "$line" != "type: local" ]; then
        echo "$line"
      fi
    elif [ "$MNEMONIC" != "$line" ]; then
      if a_in_b "${KEY_NAME%%v0}" "$VALIDATORS"; then
        echo "mnemonic: \"$(stoml "${HOME_DIR}/key_seed.json" secret)\""
      elif a_in_b "${KEY_NAME%%n0}" "$FULL_NODES"; then
        echo "mnemonic: \"$(stoml "${HOME_DIR}/key_seed.json" secret)\""
      elif [ "${KEY_NAME}" = "wallet" ]; then
        echo "mnemonic: \"$(stoml "${HOME_DIR}/wallet_seed.json" mnemonic)\""
      else
        echo "mnemonic: \"\""
      fi
    elif [ "$THRESHOLD" != "$line" ]; then
      if [ "$line" != "threshold: 0" ]; then
        echo "$line"
      fi
    elif [ "$PUBKEYS" != "$line" ]; then
      if [ "$line" != "pubkeys: []" ]; then
        echo "$line"
      fi
    else
      echo "$line"
    fi
  done
}